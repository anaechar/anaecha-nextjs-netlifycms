---
draft: false
title: Use Netlify CMS to manage MDXs for NextJs site on Vercel
slug: use-netlify-cms-mdx-nextjs-vercel
description: In this part, I will introduce "Netlify CMS" for our NextJs site
  which is hosted on Vercel. Netlify CMS is a react application which supports
  MDX format. It will work very well to build small site like personal blog.
publishedAt: "1627378972594"
category:
  - Coding
robots: false
---
In this part, I will introduce "[Netlify CMS](http://netlifycms.org)" for our NextJs site which is hosted on Vercel. Netlify CMS is a react application which supports MDX format. It will work very well to build small site like personal blog.

To be clear, Netlify CMS is different from Netlify itself. Netlify provides services like Hosting and so on but Netlify CMS is a script to manage content.

Normally, Netlify CMS works perfectly while hosting on Netlify. However, it does not support some NextJs functionalities. This is why there are some workarounds involved to make it work on [Vercel](https://vercel.com).

## Why Netlify CMS?

Firstly, it is free. To build a personal blog, I want to minimize cost as much as possible because I want to experiment many things with this blog. It will keep changing and I do not want to pay for those changes.

I have tried many CMS solutions; for example, [Contentful](https://www.contentful.com), [Strapi](https://strapi.io), [MongoDB](https://www.mongodb.com) and pure [MDX](https://mdxjs.com) editing. Actually, working with MDX alone is great experience but with more and more contents, it makes me frustrated. The good news is that Netlify CMS supports MDX format.

Netlify CMS works with Github repository for creating, editing and deleting. Once there are changes in the repository, Vercel will know and then re-build the site.

## Introduce Netlify CMS

1. Create folders and files as followed

```
+ - contents
+   - posts
+   - posts-settings
+     - categories.yml
+   - pages
  - pages
    - api
+     - lib
+       - config.ts
+     - auth.ts
+     - callback.ts
  - public
+   - admin
+     - index.html
+     - config.yml
```

2. Paste the code below inside the **index.html** file, this will create admin page for Netlify CMS.

```html
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
  <!-- Include the script that builds the page and powers Netlify CMS -->
  <script src="https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js"></script>
</body>
</html>
```

3. Paste code below inside the **config.yml** file (Replace your-repo and your-base-url with yours), this will configure Netlify CMS settings.\
   To learn more about this file, visit this [documentation](https://www.netlifycms.org/docs/configuration-options/).

```
backend:
  name: github
  repo: your-repo # example: anaechar/anaecha-nextjs-netlifycms
  branch: main
  base_url: your-base-url # example: https://anaecha.com
  auth_endpoint: api/auth
collections:
  - label: "Posts"
    name: "posts"
    folder: "contents/posts"
    extension: mdx
    format: frontmatter
    create: true
    view_filters:
      - label: "Drafts"
        field: "draft"
        pattern: true
    slug: "{{fields.slug}}"
    fields:
      - {label: "Draft", name: "draft", widget: "boolean", default: false, required: false}
      - {label: "Title", name: "title", widget: "string", required: true}
      - {label: "Slug", name: "slug", widget: "string", required: true}
      - {label: "Description", name: "description", widget: "string", default: "", required: false}
      - {label: "DateTime", name: "datetime", widget: "datetime", format: "x", required: true}
      - label: "Category"
        name: "category"
        widget: "relation"
        collection: "settings"
        file: "categories"
        search_fields: ["categories.*.name"]
        display_fields: ['categories.*.name']
        value_field: "categories.*.name"
        multiple: true
        required: true
      - {label: "Tags", name: "tags", widget: "string", default: "", required: false}
      - {label: "Body", name: "body", widget: "markdown", default: "", required: true}
      - {label: "Robots", name: "robots", widget: "boolean", default: true, required: false}
  - label: "Pages"
    name: "pages"
    folder: "contents/pages"
    extension: mdx
    format: frontmatter
    create: true
    view_filters:
      - label: "Drafts"
        field: "draft"
        pattern: true
    slug: "{{fields.slug}}"
    fields:
      - {label: "Draft", name: "draft", widget: "boolean", default: false, required: false}
      - {label: "Title", name: "title", widget: "string", required: true}
      - {label: "Slug", name: "slug", widget: "string", required: true}
      - {label: "Description", name: "description", widget: "string", default: "", required: false}
      - {label: "Date", name: "date", widget: "date", format: "D MMM YYYY",required: true}
      - {label: "Body", name: "body", widget: "markdown", default: "", required: false}
      - {label: "Nav", name: "nav", widget: "boolean", default: false, required: false}
      - {label: "Robots", name: "robots", widget: "boolean", default: true, required: false}
  - label: "Settings"
    name: "settings"
    files: 
      - label: "Categories"
        name: "categories"
        file: "contents/posts-settings/categories.yml"
        fields:
          - label: "Categories"
            name: "categories"
            widget: "list"
            fields:
              - {label: "Name", name: "name", widget: "string"}
```

4. Install **@types/react**, **@types/simple-oauth2** and **[simple-oauth2](https://www.npmjs.com/package/simple-oauth2)**

```
npm install @types/react @types/simple-oauth2 simple-oauth2 --save-dev
```

5. Paste code below inside **config.ts** file

```
export const config = {
  client: {
    id: process.env.OAUTH_GITHUB_CLIENT_ID,
    secret: process.env.OAUTH_GITHUB_CLIENT_SECRET
  },
  auth: {
    tokenHost: 'https://github.com',
    tokenPath: '/login/oauth/access_token',
    authorizePath: '/login/oauth/authorize'
  }
};
```

6. Paste code below inside **auth.ts** file

```
import { IncomingMessage, ServerResponse } from 'http';
import { AuthorizationCode } from 'simple-oauth2';
import { randomBytes } from 'crypto';
import { config } from './lib/config';

export const randomString = () => randomBytes(4).toString(`hex`);

export default async (req: IncomingMessage, res: ServerResponse) => {
  const { host } = req.headers;
  const client = new AuthorizationCode(config);
  const authorizationUri = client.authorizeURL({
    redirect_uri: `https://${host}/api/callback`,
    scope: 'repo,user',
    state: randomString()
  });

  res.writeHead(301, { Location: authorizationUri });
  res.end();
};
```

7. Paste code below inside **callback.ts** file

```
import { IncomingMessage, ServerResponse } from 'http';
import { AuthorizationCode } from 'simple-oauth2';
import { config } from './lib/config';

export default async (req: IncomingMessage, res: ServerResponse) => {
  const { host } = req.headers;
  const url = new URL(`https://${host}/${req.url}`);
  const urlParams = url.searchParams;
  const code = urlParams.get('code');
  const client = new AuthorizationCode(config);
  const tokenParams = {
    code,
    redirect_uri: `https://${host}/api/callback`
  };

  try {
    const accessToken = await client.getToken(tokenParams);
    const token = accessToken.token['access_token'];
    const responseBody = renderBody('success', {
      token
    });

    res.statusCode = 200;
    res.end(responseBody);
  } catch (e) {
    res.statusCode = 200;
    res.end(renderBody('error', e));
  }
};

function renderBody(
  status: string,
  content: {
    token: string;
  }
) {
  return `
    <script>
      const receiveMessage = (message) => {
        window.opener.postMessage(
          'authorization:github:${status}:${JSON.stringify(
    content
  )}',
          message.origin
        );
        window.removeEventListener("message", receiveMessage, false);
      }
      window.addEventListener("message", receiveMessage, false);
      window.opener.postMessage("authorizing:github", "*");
    </script>
  `;
}
```

8. Push your codes to the repository by running this code

```
git add .
git commit -m "netlifycms"
git push origin main
```

## Create Github App

1. Go to [Github.com](https://github.com)
2. Click on "Account settings"
3. Click on "Developer settings"
4. Click on "New Github App"
5. Enter Github App name
6. Enter Homepage URL i.g. your-domain.com
7. Enter Callback URL to be your-domain.com/api/callback
8. Disable webhook
9. Click on "Save changes"
10. Your app will be created. Click on "Generate a new client secret" and Copy **Client ID** and **Client Secret**
11. Click on "Permissions & events" on left navigation
12. Under "Content", Set "Read & Write"
13. Click on "Save changes"
14. Click on "Install App" on left navigation
15. Install app at your repository

## Set Environment Variables on Vercel

1. Go to your domain dashboard on Vercel
2. Click on "Settings" on top navigation
3. Click on "Environment Variables" on left navigation
4. Enter names and values as followed:\
   **OAUTH_GITHUB_CLIENT_ID** as NAME and your **Client ID** as VALUE\
   **OAUTH_GITHUB_CLIENT_SECRET** as NAME and your **Client Secret** as VALUE

## Test Netlify CMS

1. Go to your-domain.com/admin/index.html
2. Click on "Sign in with Github"
3. If authorization is success, you will see Netlify CMS dashboard. Test creating posts and pages. \
   \
   The related MDX files will be stored inside /contents/posts and /content/pages. It will not reflect in your code editor. To update codes inside your code editor, run this command.

```
git pull origin main
```

That is all. Congratulation!!\
\
In the next part, I will code to display content created by Netlify CMS.

Credits:

* <https://www.youtube.com/watch?v=pPzZrWwvDNg>\
  <https://github.com/robinpokorny/netlify-cms-now>
* <https://github.com/ublabs/netlify-cms-oauth>
* [NetlifyCMS with GitHub OAuth authentication hosted on Vercel](https://www.component-driven.dev/articles/netlify-cms-github-oauth-vercel)